<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة صور الدكتور - لوحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        * { font-family: 'IBM Plex Sans Arabic', 'Inter', sans-serif; }
        .image-card {
            transition: all 0.3s ease;
        }
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .active-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-6 shadow-lg">
        <div class="container mx-auto px-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-1">
                        <i class="fas fa-images mr-2"></i>
                        إدارة صور الدكتور
                    </h1>
                    <p class="text-blue-100">التحكم في صور الدكتور في صفحات الموقع</p>
                </div>
                <a href="/admin" class="bg-white text-blue-600 px-6 py-2 rounded-lg font-semibold hover:bg-blue-50 transition">
                    <i class="fas fa-arrow-left ml-2"></i>
                    العودة للوحة التحكم
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Upload Section -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-cloud-upload-alt text-blue-600 ml-2"></i>
                رفع صورة جديدة
            </h2>
            
            <form id="uploadForm" class="space-y-6">
                <!-- Image Type -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        نوع الصورة <span class="text-red-500">*</span>
                    </label>
                    <select id="imageType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">اختر نوع الصورة</option>
                        <option value="about_hero">صورة صفحة "عن الدكتور" (Hero Image)</option>
                        <option value="contact_profile">صورة صفحة "التواصل معنا" (Profile Photo)</option>
                        <option value="other">صورة أخرى</option>
                    </select>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        الصورة <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer" id="dropZone">
                        <input type="file" id="imageFile" accept="image/*" class="hidden" required>
                        <div id="uploadPrompt">
                            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">اسحب الصورة هنا أو اضغط للاختيار</p>
                            <p class="text-sm text-gray-500">PNG, JPG, WebP (أقصى حجم: 5MB)</p>
                        </div>
                        <div id="imagePreview" class="hidden">
                            <img src="" alt="معاينة" class="max-w-md mx-auto rounded-lg shadow-lg mb-4">
                            <button type="button" onclick="resetUpload()" class="text-red-600 hover:text-red-700 font-semibold">
                                <i class="fas fa-times ml-2"></i>
                                إلغاء
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Alt Text Arabic -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        النص البديل (عربي)
                    </label>
                    <input type="text" id="altTextAr" placeholder="د. محمد سعيد - استشاري جراحة القولون والمستقيم" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <!-- Alt Text English -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        النص البديل (English)
                    </label>
                    <input type="text" id="altTextEn" placeholder="Dr. Mohammed Saeed - Consultant Colorectal Surgeon" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" dir="ltr">
                </div>

                <!-- Active Checkbox -->
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="isActive" checked class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="isActive" class="text-gray-700 font-semibold">
                        تفعيل هذه الصورة تلقائياً (سيتم إلغاء تفعيل الصور الأخرى من نفس النوع)
                    </label>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-blue-800 transition shadow-lg">
                    <i class="fas fa-upload ml-2"></i>
                    رفع الصورة
                </button>
            </form>

            <!-- Progress Bar -->
            <div id="uploadProgress" class="hidden mt-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold text-gray-700">جاري الرفع...</span>
                    <span id="progressPercent" class="text-sm font-semibold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Images List -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-images text-blue-600 ml-2"></i>
                الصور المرفوعة
            </h2>

            <!-- Filter Tabs -->
            <div class="flex gap-4 mb-6 border-b border-gray-200">
                <button onclick="filterImages('all')" class="filter-tab px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600">
                    الكل
                </button>
                <button onclick="filterImages('about_hero')" class="filter-tab px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 transition">
                    صفحة "عن الدكتور"
                </button>
                <button onclick="filterImages('contact_profile')" class="filter-tab px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 transition">
                    صفحة "التواصل"
                </button>
                <button onclick="filterImages('other')" class="filter-tab px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 transition">
                    أخرى
                </button>
            </div>

            <!-- Images Grid -->
            <div id="imagesGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Images will be loaded here -->
                <div class="col-span-full text-center py-12 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p>جاري تحميل الصور...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl hidden items-center gap-3 z-50">
        <i class="fas fa-check-circle text-2xl"></i>
        <span id="toastMessage" class="font-semibold"></span>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentFilter = 'all';

        // File Upload Handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('imageFile');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const imagePreview = document.getElementById('imagePreview');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                previewImage(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                previewImage(e.target.files[0]);
            }
        });

        function previewImage(file) {
            if (!file.type.startsWith('image/')) {
                showToast('❌ يرجى اختيار ملف صورة صالح', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('❌ حجم الصورة يجب أن يكون أقل من 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadPrompt.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                imagePreview.querySelector('img').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            fileInput.value = '';
            uploadPrompt.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            imagePreview.querySelector('img').src = '';
        }

        // Upload Form Handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const imageType = document.getElementById('imageType').value;
            const file = fileInput.files[0];
            const altTextAr = document.getElementById('altTextAr').value;
            const altTextEn = document.getElementById('altTextEn').value;
            const isActive = document.getElementById('isActive').checked ? 1 : 0;

            if (!imageType || !file) {
                showToast('❌ يرجى اختيار نوع الصورة والملف', 'error');
                return;
            }

            try {
                // Show progress
                uploadProgress.classList.remove('hidden');
                progressBar.style.width = '30%';
                progressPercent.textContent = '30%';

                // First, upload to media library
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;
                    
                    progressBar.style.width = '60%';
                    progressPercent.textContent = '60%';

                    const uploadResponse = await axios.post(`${API_BASE}/api/admin/media/upload-file`, {
                        filename: file.name,
                        data: base64,
                        alt_text_ar: altTextAr || `صورة الدكتور - ${imageType}`,
                        alt_text_en: altTextEn || `Doctor Image - ${imageType}`
                    });

                    if (uploadResponse.data.success) {
                        progressBar.style.width = '80%';
                        progressPercent.textContent = '80%';

                        // Then, add to doctor_images table
                        const doctorImageResponse = await axios.post(`${API_BASE}/api/admin/doctor-images`, {
                            image_type: imageType,
                            image_url: uploadResponse.data.fileUrl,
                            alt_text_ar: altTextAr,
                            alt_text_en: altTextEn,
                            is_active: isActive
                        });

                        progressBar.style.width = '100%';
                        progressPercent.textContent = '100%';

                        if (doctorImageResponse.data.success) {
                            showToast('✅ ' + doctorImageResponse.data.message, 'success');
                            document.getElementById('uploadForm').reset();
                            resetUpload();
                            
                            setTimeout(() => {
                                uploadProgress.classList.add('hidden');
                                progressBar.style.width = '0%';
                                loadImages();
                            }, 1000);
                        }
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Upload error:', error);
                showToast('❌ فشل رفع الصورة: ' + (error.response?.data?.error || error.message), 'error');
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        });

        // Load Images
        async function loadImages() {
            try {
                const url = currentFilter === 'all' 
                    ? `${API_BASE}/api/admin/doctor-images`
                    : `${API_BASE}/api/admin/doctor-images?type=${currentFilter}`;
                    
                const response = await axios.get(url);
                
                if (response.data.success) {
                    displayImages(response.data.images);
                }
            } catch (error) {
                console.error('Load images error:', error);
                document.getElementById('imagesGrid').innerHTML = `
                    <div class="col-span-full text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>فشل تحميل الصور</p>
                    </div>
                `;
            }
        }

        // Display Images
        function displayImages(images) {
            const grid = document.getElementById('imagesGrid');
            
            if (!images || images.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-image text-6xl mb-4 opacity-50"></i>
                        <p>لا توجد صور متاحة</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = images.map(img => {
                const typeName = img.image_type === 'about_hero' ? 'عن الدكتور'
                    : img.image_type === 'contact_profile' ? 'التواصل'
                    : 'أخرى';
                    
                return `
                    <div class="image-card bg-white rounded-xl shadow-lg overflow-hidden relative">
                        ${img.is_active ? '<div class="active-badge"><i class="fas fa-check ml-1"></i> نشط</div>' : ''}
                        
                        <img src="${img.image_url}" alt="${img.alt_text_ar || 'صورة الدكتور'}" class="w-full h-64 object-cover">
                        
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full">
                                    ${typeName}
                                </span>
                                <span class="text-sm text-gray-500">
                                    #${img.id}
                                </span>
                            </div>
                            
                            <p class="text-gray-700 mb-2 text-sm"><strong>عربي:</strong> ${img.alt_text_ar || '-'}</p>
                            <p class="text-gray-700 mb-4 text-sm" dir="ltr"><strong>English:</strong> ${img.alt_text_en || '-'}</p>
                            
                            <div class="flex gap-2">
                                ${!img.is_active ? `
                                    <button onclick="setActive(${img.id})" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition">
                                        <i class="fas fa-check ml-1"></i>
                                        تفعيل
                                    </button>
                                ` : ''}
                                <button onclick="deleteImage(${img.id})" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition">
                                    <i class="fas fa-trash ml-1"></i>
                                    حذف
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Set Active Image
        async function setActive(imageId) {
            if (!confirm('هل تريد تفعيل هذه الصورة؟ (سيتم إلغاء تفعيل الصور الأخرى من نفس النوع)')) return;
            
            try {
                const response = await axios.put(`${API_BASE}/api/admin/doctor-images/${imageId}/set-active`);
                if (response.data.success) {
                    showToast('✅ ' + response.data.message, 'success');
                    loadImages();
                }
            } catch (error) {
                console.error('Set active error:', error);
                showToast('❌ فشل تفعيل الصورة', 'error');
            }
        }

        // Delete Image
        async function deleteImage(imageId) {
            if (!confirm('هل أنت متأكد من حذف هذه الصورة؟')) return;
            
            try {
                const response = await axios.delete(`${API_BASE}/api/admin/doctor-images/${imageId}`);
                if (response.data.success) {
                    showToast('✅ ' + response.data.message, 'success');
                    loadImages();
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('❌ فشل حذف الصورة', 'error');
            }
        }

        // Filter Images
        function filterImages(type) {
            currentFilter = type;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-600');
            });
            event.target.classList.remove('text-gray-600');
            event.target.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            
            loadImages();
        }

        // Show Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toast.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50';
                icon.className = 'fas fa-check-circle text-2xl';
            } else {
                toast.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50';
                icon.className = 'fas fa-exclamation-circle text-2xl';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Initial Load
        loadImages();
    </script>
</body>
</html>
